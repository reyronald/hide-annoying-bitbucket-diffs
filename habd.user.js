// ==UserScript==
// @name         Hide Annoying BitBucket Diffs Fork
// @namespace    https://github.com/reyronald/hide-annoying-bitbucket-diffs/
// @version      1
// @description  Hides bulky diff blocks for autogenerated files in BitBucket pull requests using RegExp patterns defined by clear-text resource
// @author       Ronald Rey (reyronald@gmail.com)
// @match        https://*.bitbucket.org/*/pull-requests/*
// ==/UserScript==

(function() {
    'use strict';

    const textSource = `
.xsd$
.wsdl$
Reference.cs$
Reference.svcmap$
.datasource
.svg$
.jpg$
.bmp$
.png$
.gif$
.cur$
.eot$
.ttf$
.woff$
.resx$
package-lock.json
`.trim();

    const patterns = textSource.split(/\r?\n/).map((pattern) => new RegExp(pattern));

    const timer = setInterval(function() {
        const filesChanged = [...document.querySelectorAll('#commit-files-summary > li')].map(li => li.getAttribute('data-file-identifier'));
        const filesToRemove = filesChanged.filter(filename => patterns.some(re => re.test(filename)));

        if (filesChanged.length) {
            clearInterval(timer);

            // TODO: Replace this setTimeout approach with some kind of DOM Observer
            // NOTE TO SELF: When completed,test with the file 
            // `/ProdoctivitySvc/ProdoctivityClientService9.xsd` in the PR
            // https://bitbucket.org/novosit/prodoctivity/pull-requests/371?w=1
            setTimeout(function() {
                filesToRemove.forEach(filename => {
                    const diffBlock = document.querySelector(`section[data-identifier="${filename}"]`);
                    if (diffBlock !== null) {
                       diffBlock.remove();
                    }
                });
            }, 1000);
        }
    }, 500);
})();
